{% extends "base.html" %}
{% block title %}Tax Lots - Certificate #{{ cert.id }}{% endblock %}
{% block nav_brand %}Investor Portal{% endblock %}
{% block nav_links %}
{% include "portal/_nav.html" %}
{% endblock %}

{% block content %}
<h1>Tax Lots &mdash; Certificate #{{ cert.id }}</h1>
<a href="{{ url_for('portal.certificate_detail', cert_id=cert.id) }}">&larr; Back to Certificate</a>

<article>
    <header>Summary</header>
    <p>
        <span class="badge badge-{{ cert.plan_type|lower }}">{{ cert.plan_type }}</span>
        {{ cert.plan_name }}
        {% if cert.tax_regime %} | Regime: <strong>{{ cert.tax_regime }}</strong>{% endif %}
    </p>
    <div class="grid">
        <div>
            <p>Total Value: <strong>R${{ "%.2f"|format(total_value) }}</strong></p>
            {% if cert.plan_type == 'VGBL' %}
            <p>Premium Basis (P<sub>rem</sub>): <strong>R${{ "%.2f"|format(P_rem) }}</strong></p>
            {% else %}
            <p>Cost Basis (FIFO Remaining): <strong>R${{ "%.2f"|format(total_remaining) }}</strong></p>
            {% endif %}
        </div>
        <div>
            <p>Unit Price: <strong>R${{ "%.6f"|format(unit_price) }}</strong> | Unit Supply: <strong>{{ "%.4f"|format(unit_supply) }}</strong></p>
            {% if cert.plan_type == 'VGBL' %}
            <p>Taxable Earnings: <strong style="color:#4CAF50">R${{ "%.2f"|format([0, total_value - P_rem]|max) }}</strong> ({{ "%.1f"|format([0, (1 - P_rem / total_value) * 100]|max if total_value > 0 else 0) }}% of value)</p>
            {% else %}
            <p>Total Earnings: <strong style="color:#4CAF50">R${{ "%.2f"|format(total_value - total_remaining) }}</strong></p>
            {% endif %}
        </div>
    </div>
</article>

<article style="border-left: 4px solid #42A5F5; padding-left: 1em;">
    <strong>How Tax Lots Work (Certificate Units):</strong>
    <ul>
        <li><strong>Units</strong>: each contribution buys certificate units at the current unit price. Lot value = units &times; unit_price.</li>
        <li><strong>Original Amount</strong>: what you contributed (or transferred in)</li>
        <li><strong>Current Value</strong>: units_remaining &times; unit_price (captures actual growth per lot)</li>
        <li><strong>Earnings</strong>: {% if cert.plan_type == 'VGBL' %}allocated pro-rata using certificate-level earnings ratio = 1 &minus; P<sub>rem</sub>/total_value (not per-lot cost basis){% else %}current value &minus; cost basis{% endif %}</li>
        <li><strong>Regressive Rate</strong>: based on the exact age in days of each lot; rate drops over time (FIFO)</li>
        <li>On withdrawal, the <strong>oldest lots are consumed first</strong> (FIFO). Tax is computed per lot.</li>
    </ul>
</article>

{% if lots %}
<table>
    <thead>
        <tr>
            <th>Lot #</th>
            <th>Date</th>
            <th>Source</th>
            <th>{% if cert.plan_type == 'VGBL' %}Original<br><small style="opacity:0.6">(FIFO-tracked)</small>{% else %}Original{% endif %}</th>
            <th>Units Rem.</th>
            <th>Current Value</th>
            {% if cert.plan_type == 'VGBL' %}<th>Earnings</th>{% endif %}
            <th>Age</th>
            <th>Regressive Rate</th>
            <th>Next Drop</th>
        </tr>
    </thead>
    <tbody>
    {% for lot in lots %}
    <tr{% if lot.units_remaining <= 0.000001 %} style="opacity:0.4"{% endif %}>
        <td>{{ lot.id }}</td>
        <td>{{ lot.date }}</td>
        <td>
            {% if lot.source_type == 'transfer_internal' %}
                <span style="color: #42A5F5">Transfer (internal)</span>
            {% elif lot.source_type == 'transfer_external' %}
                <span style="color: #ff9800">Transfer (external)</span>
            {% elif lot.source_type == 'portability' %}
                <span style="color: #AB47BC">Portability</span>
            {% else %}
                Regular
            {% endif %}
        </td>
        <td>R${{ "%.2f"|format(lot.original_amount) }}</td>
        <td>{{ "%.4f"|format(lot.units_remaining) }}</td>
        <td>R${{ "%.2f"|format(lot.current_value) }}</td>
        {% if cert.plan_type == 'VGBL' %}
        <td style="color:#4CAF50">R${{ "%.2f"|format(lot.earnings) }}</td>
        {% endif %}
        <td>{{ lot.days_held }}d ({{ lot.months_held }}m)</td>
        <td>{{ "%.0f"|format(lot.current_rate * 100) }}%</td>
        <td>
            {% if lot.next_bracket %}
                {{ "%.0f"|format(lot.next_bracket.rate * 100) }}% in ~{{ lot.next_bracket.months_until }}mo ({{ lot.next_bracket.days_until }}d)
            {% else %}
                <span style="color:#4CAF50">Minimum rate (10%)</span>
            {% endif %}
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>
{% else %}
<p>No tax lots. <a href="{{ url_for('portal.contribute', cert_id=cert.id) }}">Make a contribution</a> to create the first lot.</p>
{% endif %}
{% endblock %}
