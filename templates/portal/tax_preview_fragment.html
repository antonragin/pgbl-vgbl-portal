{% if result.get('error') %}
<p style="color:#f44336">{{ result.error }}</p>
{% else %}
<article>
    <header>Tax Estimate for R${{ "%.2f"|format(result.withdrawal_amount) }}</header>
    <p>{{ result.plan_type }} | Value: R${{ "%.2f"|format(result.total_value) }} | Unit Price: R${{ "%.6f"|format(result.unit_price) }}</p>

    {% if result.get('regressive') and result.get('progressive') %}
    <div class="grid">
        <div>
            {% set r = result.regressive %}
            <h4>Regressive Regime</h4>
            <p>Tax: <strong style="color:#f44336">R${{ "%.2f"|format(r.tax) }}</strong></p>
            <p>Net received: <strong style="color:#4CAF50">R${{ "%.2f"|format(r.net) }}</strong></p>
            <p>Effective rate: {{ "%.2f"|format(r.effective_rate * 100) }}%</p>
            {% if result.get('projected_brokerage_regressive') is not none %}
            <p><small>Projected brokerage: R${{ "%.2f"|format(result.projected_brokerage_regressive) }}</small></p>
            {% endif %}
            {% if r.breakdown %}
            <details>
                <summary>FIFO Breakdown ({{ r.breakdown|length }} tranches)</summary>
                <table style="font-size:0.8em">
                    <thead><tr><th>Value</th><th>Units</th><th>Age</th><th>Rate</th><th>Taxable</th><th>Tax</th></tr></thead>
                    <tbody>
                    {% for b in r.breakdown[:10] %}
                    <tr>
                        <td>R${{ "%.2f"|format(b.tranche_amount) }}</td>
                        <td>{{ "%.4f"|format(b.units_consumed) }}</td>
                        <td>{{ b.days_held }}d</td>
                        <td>{{ "%.0f"|format(b.rate * 100) }}%</td>
                        <td>R${{ "%.2f"|format(b.taxable) }}</td>
                        <td>R${{ "%.2f"|format(b.tax) }}</td>
                    </tr>
                    {% endfor %}
                    {% if r.breakdown|length > 10 %}
                    <tr><td colspan="6"><em>+{{ r.breakdown|length - 10 }} more</em></td></tr>
                    {% endif %}
                    </tbody>
                </table>
            </details>
            {% endif %}
        </div>
        <div>
            {% set p = result.progressive %}
            <h4>Progressive Regime &mdash; IRRF antecipa&ccedil;&atilde;o <small>(estimated)</small></h4>
            <p>Withheld (15%): <strong style="color:#f44336">R${{ "%.2f"|format(p.tax_withheld_15pct) }}</strong></p>
            <p>Net received: <strong style="color:#4CAF50">R${{ "%.2f"|format(p.net) }}</strong></p>
            <p>Taxable base: R${{ "%.2f"|format(p.taxable_base) }}</p>
            {% if p.get('estimated_final_tax') is not none %}
            <p><small>Estimated final tax (monthly brackets): R${{ "%.2f"|format(p.estimated_final_tax) }}</small></p>
            {% endif %}
            <p><small>{{ p.get('note', '15% withholding is an advance payment. Final tax depends on annual income.') }}</small></p>
            {% if result.get('projected_brokerage_progressive') is not none %}
            <p><small>Projected brokerage: R${{ "%.2f"|format(result.projected_brokerage_progressive) }}</small></p>
            {% endif %}
        </div>
    </div>
    {% else %}
    {% if result.get('regressive') %}
    {% set r = result.regressive %}
    <h4>Regressive Regime</h4>
    <p>Gross: R${{ "%.2f"|format(r.gross) }} | Tax: <strong style="color:#f44336">R${{ "%.2f"|format(r.tax) }}</strong> | Net: <strong style="color:#4CAF50">R${{ "%.2f"|format(r.net) }}</strong> | Effective rate: {{ "%.2f"|format(r.effective_rate * 100) }}%</p>
    {% if r.breakdown %}
    <details>
        <summary>FIFO Breakdown ({{ r.breakdown|length }} tranches)</summary>
        <table>
            <thead><tr><th>Value</th><th>Units</th><th>Age</th><th>Rate</th><th>Taxable</th><th>Tax</th></tr></thead>
            <tbody>
            {% for b in r.breakdown[:10] %}
            <tr>
                <td>R${{ "%.2f"|format(b.tranche_amount) }}</td>
                <td>{{ "%.4f"|format(b.units_consumed) }}</td>
                <td>{{ b.days_held }}d</td>
                <td>{{ "%.0f"|format(b.rate * 100) }}%</td>
                <td>R${{ "%.2f"|format(b.taxable) }}</td>
                <td>R${{ "%.2f"|format(b.tax) }}</td>
            </tr>
            {% endfor %}
            {% if r.breakdown|length > 10 %}
            <tr><td colspan="6"><em>... and {{ r.breakdown|length - 10 }} more tranches</em></td></tr>
            {% endif %}
            </tbody>
        </table>
    </details>
    {% endif %}
    {% endif %}

    {% if result.get('progressive') %}
    {% set p = result.progressive %}
    <h4>Progressive Regime &mdash; IRRF antecipa&ccedil;&atilde;o <small>(estimated)</small></h4>
    <p>Gross: R${{ "%.2f"|format(p.gross) }} | Taxable base: R${{ "%.2f"|format(p.taxable_base) }} | Withheld (15%): <strong style="color:#f44336">R${{ "%.2f"|format(p.tax_withheld_15pct) }}</strong> | Net: <strong style="color:#4CAF50">R${{ "%.2f"|format(p.net) }}</strong></p>
    {% if p.get('estimated_final_tax') is not none %}
    <p><small>Estimated final tax (monthly brackets): R${{ "%.2f"|format(p.estimated_final_tax) }}</small></p>
    {% endif %}
    <p><small>{{ p.get('note', '15% withholding is an advance payment. Final tax depends on annual income.') }}</small></p>
    {% endif %}
    {% endif %}

    {% if result.get('projected_cert_value') is not none %}
    <p style="opacity:0.7"><small>After withdrawal: certificate value ~ R${{ "%.2f"|format(result.projected_cert_value) }}</small></p>
    {% endif %}
</article>
{% endif %}
