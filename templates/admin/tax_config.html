{% extends "base.html" %}
{% block title %}Tax Configuration{% endblock %}
{% block nav_brand %}Admin Panel{% endblock %}

{% block content %}
<h1>Tax Configuration</h1>
<p><a href="{{ url_for('admin.dashboard') }}">&larr; Back to Dashboard</a></p>

<article>
    <header>Progressive IRPF Brackets (Monthly){% if is_default %} <small>(using defaults)</small>{% endif %}</header>
    <p>These brackets are used for the <strong>estimated</strong> final tax calculation under the progressive regime.
       The actual withholding is always 15% IRRF antecipacao.</p>
    <form method="post">
        <input type="hidden" name="action" value="set_progressive_brackets">
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Up to (R$)</th>
                    <th>Rate (%)</th>
                    <th>Deduction (R$)</th>
                </tr>
            </thead>
            <tbody>
                {% for b in brackets %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td><input type="text" name="bracket_{{ loop.index0 }}_up_to" value="{{ b[0] }}" style="width:120px"></td>
                    <td><input type="number" step="0.001" name="bracket_{{ loop.index0 }}_rate" value="{{ b[1] }}" style="width:100px"></td>
                    <td><input type="number" step="0.01" name="bracket_{{ loop.index0 }}_deduction" value="{{ b[2] }}" style="width:120px"></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <fieldset role="group">
            <button type="submit">Save Brackets</button>
        </fieldset>
    </form>
    <form method="post" style="margin-top: 0.5rem">
        <input type="hidden" name="action" value="reset_progressive_brackets">
        <button type="submit" class="secondary outline">Reset to Defaults</button>
    </form>
</article>

<article>
    <header>IOF Configuration</header>
    <p>Current IOF thresholds (read-only display):</p>
    <table>
        <thead>
            <tr><th>Year From</th><th>Year To</th><th>Limit (R$)</th><th>Rate</th></tr>
        </thead>
        <tbody>
            {% for rule in iof_config.get('thresholds', []) %}
            <tr>
                <td>{{ rule.year_from }}</td>
                <td>{{ rule.year_to }}</td>
                <td>R${{ "{:,.0f}".format(rule.limit) }}</td>
                <td>{{ "%.1f"|format(rule.rate * 100) }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</article>
{% endblock %}
